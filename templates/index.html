<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asana Encoder</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
  <style>
    body {
      background-color: #1e1e1e;
      margin: 0;
      padding: 2rem;
      font-family: 'Arial', sans-serif;
      color: #fff;
    }

    h1 {
      margin-top: 0;
      background-color: #333;
      padding: 15px;
      border-radius: 6px;
      color: #fff;
      font-size: 1.5rem;
      text-align: left; /* Left justify the header */
    }

    .top-controls {
      display: flex;
      justify-content: flex-start; /* Keep the auto-refresh toggle close to the refresh button */
      margin-bottom: 1rem;
      gap: 1rem;
    }

    .refresh-btn {
      padding: 8px 16px;
      background-color: #007bff;
      border: none;
      border-radius: 4px;
      color: white;
      font-size: 14px;
      cursor: pointer;
    }

    .file-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      justify-content: center;
    }

    .file-entry {
      background-color: #333;
      border-radius: 8px;
      width: 100%;
      max-width: 380px;
      display: flex;
      flex-direction: column;
      margin-top: 1rem;
      box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.3);
    }

    .file-header {
      background-color: #444;
      padding: 12px 15px;
      font-weight: bold;
      font-size: 1rem;
      /* border-bottom: 1px solid #555; */
    }

    .file-header span {
      float: right;
      background-color: #cc3333;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
    }

    video {
      width: 100%;
      height: auto;
      /* border-bottom: 1px solid #555;*/
    }

    .button-row {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      /* border-top: 1px solid #555; */
      gap: 14px; /* Increased space between buttons */
    }

    .encode-btn, .still-btn, .delete-btn {
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      color: white;
      border: none;
    }

    .encode-btn {
      background-color: #007bff;
    }
    
    .encode-btn:hover {
      background-color: #066cd8;
    }

    .encode-btn.encoded {
      background-color: #4caf50;
    }

    .encode-btn.encoded:hover {
      background-color: #3f9342;
    }

    .still-btn {
      background-color: #ff9800;
    }

    .still-btn:hover {
      background-color: #e38b06;
    }

    .still-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .delete-btn {
      background-color: #f44336;
    }

    .delete-btn:hover {
      background-color: #e53935;
    }

    .progress-container {
      width: 100%;
      background-color: #636363;
      height: 10px;
      border-radius: 5px;
      margin-top: 5px;
    }

    .progress-bar {
      height: 100%;
      background-color: #4caf50;
      width: 0%;
      transition: width 0.5s;
    }

    .no-files-message {
      font-size: 1.5rem;
      color: #bbb;
      text-align: center;
      margin-top: 3rem;
    }

    .toggle-container {
      display: flex;
      align-items: center;
      font-size: 14px;
      color: white;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 42px;
      height: 24px;
      margin-left: 8px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .2s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .2s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #007bff;
    }

    input:checked + .slider:before {
      transform: translateX(18px);
    }
  </style>
</head>
<body>
  <h1>Asana Preview Encoder</h1>

  <div class="top-controls">
    <button class="refresh-btn" onclick="location.reload()">Refresh</button>
    <div class="toggle-container">
      Auto-refresh
      <label class="switch">
        <input type="checkbox" id="auto-refresh-toggle" checked>
        <span class="slider"></span>
      </label>
    </div>
  </div>

  {% if files|length == 0 %}
    <div class="no-files-message">Add movies to the folder</div>
  {% endif %}

  <div class="file-grid">
  {% for file in files %}
    <div class="file-entry">
      <div class="file-header">
        {{ file.basename }}
        {% if "countdown" in file.basename.lower() %}
        <span>CD</span>
        {% endif %}
      </div>
      <div style="padding: 10px; display: flex; flex-direction: column; align-items: center;">
      {% if file.encoded %}
        <video controls controlslist="nofullscreen nopictureinpicture" data-filename="{{ file.name }}">
          <source src="{{ url_for('serve_video', filename=file.mp4) }}" type="video/mp4">
          Your browser does not support HTML5 video.
        </video>
      {% elif file.thumb %}
        <div style="width: 320px; height: 180px; background: #909090; display: flex; align-items: center; justify-content: center;">
          <img
            src="{{ url_for('serve_video', filename=file.thumb) }}"
            style="max-width: 320px; max-height: 180px; width: auto; height: auto;"
            alt="Thumbnail for {{ file.name }}"
            data-filename="{{ file.name }}"
          >
        </div>
      {% else %}
        <div style="width: 320px; height: 180px; background: #333; display:flex; align-items:center; justify-content:center; color:#888;">No preview available</div>
      {% endif %}
      <div class="button-row">
        <button class="encode-btn {% if file.encoded %}encoded{% endif %}" data-filename="{{ file.name }}">Encode</button>
        <button class="still-btn" data-filename="{{ file.name }}" {% if not file.encoded %}hidden{% endif %}>Export Still</button>
        <button class="delete-btn" data-filename="{{ file.name }}">Delete</button>
      </div>
      <div class="progress-container">
        <div class="progress-bar" id="progress-{{ file.name | replace('.', '_') }}"></div>
      </div>
      </div>
    </div>
  {% endfor %}
  </div>

  <script>
    const encodeButtons = document.querySelectorAll('.encode-btn');
    const stillButtons = document.querySelectorAll('.still-btn');
    const deleteButtons = document.querySelectorAll('.delete-btn');
    const autoRefreshToggle = document.getElementById('auto-refresh-toggle');

    encodeButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const filename = btn.dataset.filename;
        const originalText = btn.textContent;

        btn.disabled = true;
        btn.textContent = 'Encoding...';
        btn.classList.remove('encoded');

        await fetch('/encode_one', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename })
        });

        pollProgress(filename, btn, originalText);
      });
    });

    stillButtons.forEach(stillBtn => {
      stillBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        if (stillBtn.disabled) return;
        const filename = stillBtn.dataset.filename;
        const video = document.querySelector(`video[data-filename="${filename}"]`);
        if (!video) {
          stillBtn.textContent = 'No video loaded';
          return;
        }
        const time = video.currentTime;
        const timecode = new Date(time * 1000).toISOString().substr(11, 8);

        stillBtn.disabled = true;
        stillBtn.textContent = 'Exporting...';

        const res = await fetch('/export_still', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename, timecode })
        });

        const result = await res.json();
        if (result.status === 'success') {
          stillBtn.textContent = 'Export Again';
          const image = document.createElement('img');
          image.src = `/video/${result.output}`;
          image.width = 320;
          image.height = 180;
          image.alt = `Still of ${filename}`;

          const container = stillBtn.closest('.file-entry');
          const existingImage = container.querySelector('img');
          if (existingImage) existingImage.remove();

          container.insertBefore(image, container.querySelector('.button-row'));
        } else {
          stillBtn.textContent = 'Export Failed';
        }
        stillBtn.disabled = false;
      });
    });

    // Adding event listener for Delete buttons
    deleteButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const filename = btn.dataset.filename;

        const confirmation = confirm(`Are you sure you want to delete ${filename}?`);
        if (!confirmation) return;

        // Send the delete request to the server
        const res = await fetch('/delete_file', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename })
        });

        const result = await res.json();
        if (result.status === 'success') {
          // If the deletion is successful, remove the file entry from the DOM
          const fileEntry = btn.closest('.file-entry');
          fileEntry.remove();
        } else {
          alert(result.error || 'An error occurred while deleting the files.');
        }
      });
    });

    function pollProgress(filename, button, originalText) {
      const id = filename.replace(/\./g, '_');
      const bar = document.getElementById(`progress-${id}`);
      const stillBtn = document.querySelector(`.still-btn[data-filename="${filename}"]`);

      const interval = setInterval(async () => {
        const res = await fetch('/progress');
        const data = await res.json();

        for (const key in data) {
          if (data[key].filename === filename) {
            const progress = data[key].progress;
            if (bar) bar.style.width = progress + '%';

            if (progress >= 100) {
              clearInterval(interval);
              location.reload();
              button.disabled = false;
              button.textContent = originalText;
              button.classList.add('encoded');

              if (stillBtn) stillBtn.disabled = false;
            }
          }
        }
      }, 1000);
    }

    // Auto-refresh every 45 seconds (unless disabled)
    setInterval(() => {
      if (autoRefreshToggle.checked) {
        location.reload();
      }
    }, 45000);
  </script>
</body>
</html>